<!DOCTYPE html><html lang="en"><title>配置 IPv6 与 Cloudflare DDNS - OS</title><meta charset="utf-8"><meta name="description"content="配置 IPv6 与 Cloudflare DDNS"><meta name="keywords"><meta name="subtitle"content="Code &amp; Life"><meta name="author"content="zowiegong"><meta name="language"content="zh-CN"><meta name="timezone"content="Asia/Shanghai"><meta name="viewport"content="width=device-width,initial-scale=1"><link href="/manifest.json"rel="manifest"><link href="/atom.xml"rel="alternate"type="application/atom+xml"><link href="/images/favicon.ico"rel="shortcut icon"type="image/x-icon"><link href="/css/style.css"rel="stylesheet"><link href="/css/post.css"rel="stylesheet"><meta name="generator"content="Hexo 4.2.0"><header id="header-container"><h1 id="blog-title"><a href="/">OS</a></h1><nav><ul class="menu-list"><li class="menu-list-item"><a href="/categories"class="menu-name">categories</a><li class="menu-list-item"><a href="/tags"class="menu-name">tags</a><li class="menu-list-item"><a href="/about"class="menu-name">about</a></ul></nav></header><article class="main"><h1 id="post-title">配置 IPv6 与 Cloudflare DDNS</h1><div class="post-info"><time class="post-date">2019-06-10</time><ul class="tag-list"><li class="tag-item"><a href="/tags/network/"class="tag-name">#network</a></ul></div><section class="markdown-body"><h2><a href="#ipv6-%E9%85%8D%E7%BD%AE"class="anchor"aria-hidden="true"id="user-content-ipv6-配置"><span class="octicon octicon-link"aria-hidden="true"></span></a>IPv6 配置</h2><p>新办的电信 200M 光纤宽带没有 IPv4 外网地址，尝试获取 IPv6 地址。<h3><a href="#%E9%85%8D%E7%BD%AE%E5%85%89%E7%8C%AB"class="anchor"aria-hidden="true"id="user-content-配置光猫"><span class="octicon octicon-link"aria-hidden="true"></span></a>配置光猫</h3><p>超级管理员密码<code>nE7jA%5m</code>登陆光猫，<code>网络</code>-<code>网络设置</code>-<code>IP模式</code>选择<code>IPv4%IPv6</code>。<h3><a href="#%E8%B7%AF%E7%94%B1%E5%99%A8%E9%85%8D%E7%BD%AE"class="anchor"aria-hidden="true"id="user-content-路由器配置"><span class="octicon octicon-link"aria-hidden="true"></span></a>路由器配置</h3><p>启用 IPv6，连接类型<code>Native DHCPv6</code>、<code>Stateless:RA</code>，DNS 自动获取，内网 Ipv6 地址通过 DHCPv6 获取。<h3><a href="#%E9%87%8D%E6%96%B0%E6%8B%A8%E5%8F%B7"class="anchor"aria-hidden="true"id="user-content-重新拨号"><span class="octicon octicon-link"aria-hidden="true"></span></a>重新拨号</h3><p>重新拨号，此时路由器与内网设备应该能正常获取到 IPv6 地址。<p><a href="https://ipv6-test.com/"target="_blank"rel="nofollow noopener">IPv6 测试地址</a><h2><a href="#cloudflare-ddns"class="anchor"aria-hidden="true"id="user-content-cloudflare-ddns"><span class="octicon octicon-link"aria-hidden="true"></span></a>Cloudflare DDNS</h2><p>IPv6 为动态获取，需要做动态域名解析，确保外网能通过域名连接家里的设备。<p>可以通过 Cloudflare 提供的<a href="https://api.cloudflare.com/#dns-records-for-a-zone-update-dns-record"target="_blank"rel="nofollow noopener">API</a>进行更新。<h3><a href="#ddns"class="anchor"aria-hidden="true"id="user-content-ddns"><span class="octicon octicon-link"aria-hidden="true"></span></a>DDNS</h3><p>对于<code>Padavan</code>、<code>OpenWrt</code>等比较开放的路由器固件，可以使用下面的<a href="https://gist.github.com/zowiegong/6349d420789bb70aaebc7ce7eb1daccf"target="_blank"rel="noopener">Shell 脚本</a>进行 DDNS:<p>API token 在 Profile 页面底部查看。<p>zoneId、dnsId 分别通过<a href="https://api.cloudflare.com/#zone-list-zones"target="_blank"rel="nofollow noopener">List Zones</a>与<a href="https://api.cloudflare.com/#dns-records-for-a-zone-list-dns-records"target="_blank"rel="nofollow noopener">List DNS Records</a>两个接口获取。<div class="highlight highlight-source-shell"><pre><span class="pl-c"><span class="pl-c">#!</span>/bin/sh</span>

EMAIL=
CF_API_KEY=
CF_ZONE_ID=
CF_DNS_ID=

DNS_RECORD=
RECORD_TYPE=AAAA

ROUTER_NETWORK_DEVICE=

<span class="pl-c"><span class="pl-c">#</span> 获取当前 DNS 记录</span>
resolving_ip=<span class="pl-s"><span class="pl-pds">$(</span>curl -k -X GET <span class="pl-s"><span class="pl-pds">"</span>https://api.cloudflare.com/client/v4/zones/<span class="pl-smi">${CF_ZONE_ID}</span>/dns_records/<span class="pl-smi">${CF_DNS_ID}</span><span class="pl-pds">"</span></span> -H <span class="pl-s"><span class="pl-pds">"</span>X-Auth-Email:<span class="pl-smi">${EMAIL}</span><span class="pl-pds">"</span></span> -H <span class="pl-s"><span class="pl-pds">"</span>X-Auth-Key:<span class="pl-smi">${CF_API_KEY}</span><span class="pl-pds">"</span></span> -H <span class="pl-s"><span class="pl-pds">"</span>Content-Type: application/json<span class="pl-pds">"</span></span> <span class="pl-k">|</span> awk -F <span class="pl-s"><span class="pl-pds">'</span>"<span class="pl-pds">'</span></span> <span class="pl-s"><span class="pl-pds">'</span>{print $18}<span class="pl-pds">'</span></span><span class="pl-pds">)</span></span>

<span class="pl-c"><span class="pl-c">#</span> 获取本机 ipv6 地址</span>
current_ip=<span class="pl-s"><span class="pl-pds">$(</span>ip -o -6 addr list <span class="pl-smi">$ROUTER_NETWORK_DEVICE</span> <span class="pl-k">|</span> awk <span class="pl-s"><span class="pl-pds">'</span>{print $4}<span class="pl-pds">'</span></span> <span class="pl-k">|</span> cut -d/ -f1 <span class="pl-k">|</span> head -n 1<span class="pl-pds">)</span></span>

<span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>当前解析 IP: <span class="pl-smi">$resolving_ip</span><span class="pl-pds">"</span></span>
<span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>当前本机 IP: <span class="pl-smi">$current_ip</span><span class="pl-pds">"</span></span>

<span class="pl-c"><span class="pl-c">#</span> 没有变化</span>
<span class="pl-k">if</span> [ <span class="pl-smi">$resolving_ip</span> <span class="pl-k">=</span> <span class="pl-smi">$current_ip</span> ]<span class="pl-k">;</span>
    <span class="pl-k">then</span>
    <span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>IP 未变化<span class="pl-pds">"</span></span>

<span class="pl-c"><span class="pl-c">#</span> 修改 DNS 记录</span>
<span class="pl-k">else</span>
    <span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>更新解析记录<span class="pl-pds">"</span></span>
    curl -k -X PUT <span class="pl-s"><span class="pl-pds">"</span>https://api.cloudflare.com/client/v4/zones/<span class="pl-smi">${CF_ZONE_ID}</span>/dns_records/<span class="pl-smi">${CF_DNS_ID}</span><span class="pl-pds">"</span></span> -H <span class="pl-s"><span class="pl-pds">"</span>X-Auth-Email:<span class="pl-smi">${EMAIL}</span><span class="pl-pds">"</span></span> -H <span class="pl-s"><span class="pl-pds">"</span>X-Auth-Key:<span class="pl-smi">${CF_API_KEY}</span><span class="pl-pds">"</span></span> -H <span class="pl-s"><span class="pl-pds">"</span>Content-Type: application/json<span class="pl-pds">"</span></span> --data <span class="pl-s"><span class="pl-pds">'</span>{"type":"<span class="pl-pds">'</span></span><span class="pl-smi">$RECORD_TYPE</span><span class="pl-s"><span class="pl-pds">'</span>","name":"<span class="pl-pds">'</span></span><span class="pl-smi">$DNS_RECORD</span><span class="pl-s"><span class="pl-pds">'</span>","content":"<span class="pl-pds">'</span></span><span class="pl-smi">$current_ip</span><span class="pl-s"><span class="pl-pds">'</span>"}<span class="pl-pds">'</span></span>
<span class="pl-k">fi</span>

<span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span> <span class="pl-pds">"</span></span></pre></div><h3><a href="#%E5%AE%9A%E6%97%B6%E6%9B%B4%E6%96%B0"class="anchor"aria-hidden="true"id="user-content-定时更新"><span class="octicon octicon-link"aria-hidden="true"></span></a>定时更新</h3><p>使用 crontab 定时更新解析记录。<p><code>0 * * * * /path/cloudflare_ddns.sh &gt;&gt; /path/ddns.log</code><p>每小时检查 IPv6 地址是否变化，然后更新解析记录，并输出日志到文件。</section></article><footer class="footer-container"><section>Copyright &copy; 2020&nbsp;<a href="mailto:zowiegong@gmail.com">zowiegong</a>&nbsp;Powered by&nbsp;<a href="https://github.com/hexojs/hexo"target="_blank"rel="noopener noreferrer">Hexo</a>&nbsp;Theme by&nbsp;<a href="https://github.com/zowiegong/hexo-theme-os"target="_blank"rel="noopener noreferrer">OS.</a><br><a href="https://github.com/zowiegong/hexo-blog/edit/master/source/_posts/配置ipv6并通过cloudflare进行ddns.md"target="_blank">Edit source file</a></section></footer><div class="hover-pointer"id="scroll-to-top-container"><svg class="hover-fill"height="3rem "id="scroll-to-top-btn"version="1.1"viewBox="0 0 1024 1024"width="3rem"><path d="M825.568 555.328l-287.392-289.28C531.808 259.648 523.488 256.576 515.2 256.64 514.08 256.544 513.12 256 512 256c-4.672 0-9.024 1.088-13.024 2.88-4.032 1.536-7.872 3.872-11.136 7.136l-259.328 258.88c-12.512 12.48-12.544 32.736-0.032 45.248 6.24 6.272 14.432 9.408 22.656 9.408 8.192 0 16.352-3.136 22.624-9.344L480 364.288 480 928c0 17.696 14.336 32 32 32s32-14.304 32-32L544 362.72l236.192 237.728c6.24 6.272 14.496 9.44 22.688 9.44s16.32-3.104 22.56-9.312C838.016 588.128 838.048 567.84 825.568 555.328z"p-id="1100"></path><path d="M864 192 160 192C142.336 192 128 177.664 128 160s14.336-32 32-32l704 0c17.696 0 32 14.336 32 32S881.696 192 864 192z"p-id="1101"></path></svg></div><script>let pluginsConfig = JSON.parse('{"googleAnalytics":"UA-121105508-1","scrollToTop":true,"scrollSmooth":false,"comments":{"enable":true,"repo":"zowiegong/hexo-blog"}}')</script><script>pluginsConfig.comments.enable = true</script><script src="/js/script.js"></script>