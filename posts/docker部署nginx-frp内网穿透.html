<!DOCTYPE html><html lang="en"><title>Docker部署 Nginx + frp 内网穿透 - OS</title><meta charset="utf-8"><meta name="description"content="Docker部署 Nginx + frp 内网穿透"><meta name="keywords"><meta name="subtitle"content="Code &amp; Life"><meta name="author"content="zowiegong"><meta name="language"content="zh-CN"><meta name="timezone"content="Asia/Shanghai"><meta name="viewport"content="width=device-width,initial-scale=1"><link href="/manifest.json"rel="manifest"><link href="/atom.xml"rel="alternate"type="application/atom+xml"><link href="/images/favicon.ico"rel="shortcut icon"type="image/x-icon"><link href="/css/style.css"rel="stylesheet"><link href="/css/post.css"rel="stylesheet"><meta name="generator"content="Hexo 4.2.0"><header id="header-container"><h1 id="blog-title"><a href="/">OS</a></h1><nav><ul class="menu-list"><li class="menu-list-item"><a href="/categories"class="menu-name">categories</a><li class="menu-list-item"><a href="/tags"class="menu-name">tags</a><li class="menu-list-item"><a href="/about"class="menu-name">about</a></ul></nav></header><article class="main"><h1 id="post-title">Docker部署 Nginx + frp 内网穿透</h1><div class="post-info"><time class="post-date">2020-03-23</time><ul class="tag-list"><li class="tag-item"><a href="/tags/nginx/"class="tag-name">#nginx</a><li class="tag-item"><a href="/tags/Docker/"class="tag-name">#Docker</a><li class="tag-item"><a href="/tags/frp/"class="tag-name">#frp</a></ul></div><section class="markdown-body"><h2><a href="#%E5%89%8D%E8%A8%80"class="anchor"aria-hidden="true"id="user-content-前言"><span class="octicon octicon-link"aria-hidden="true"></span></a>前言</h2><p>由于没有公网 IP，加上黑群晖没有洗白，无法进行外网的远程连接。<p>通过 frp 内网穿透后可以通过<code>sub.domain.com:xxx</code>的形式访问到内网的 web 服务，但是带上端口号十分不优雅也难以记忆。<p>在公网服务器上部署 Nginx 反向代理到 frp 的特定端口，即可在使用内网服务时不需要端口号了。<h2><a href="#%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2"class="anchor"aria-hidden="true"id="user-content-服务部署"><span class="octicon octicon-link"aria-hidden="true"></span></a>服务部署</h2><p>通过 docker-compose 启动 Dcoker 容器，然后通过 links 将 nginx 与 frp 容器连接，即可在 nginx 容器中将请求转发到 frp 容器。<p>前置条件：<ul><li>服务端需要 docker 环境及 docker-compose<li>nginx 镜像<li>snowdreamtech/frps 镜像</ul><p>frp docker 部署有个坑，一开始<code>fatedier/frp</code>镜像一直不能成功访问，报<code>read error</code>的错误。<p>后来一看镜像更新时间已经是 4 年前了，换了 Pulls 量最多的<code>snowdreamtech/frps</code>解决。<h3><a href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"class="anchor"aria-hidden="true"id="user-content-目录结构"><span class="octicon octicon-link"aria-hidden="true"></span></a>目录结构</h3><pre><code>.
├── docker-compose.yml
├── frp
│   └── config
│       └── frps.ini
└── nginx
    ├── config
    │   ├── conf.d
    │   │   └── default.conf
    │   └── nginx.conf
    └── logs
        ├── access.log
        └── error.log
</code></pre><p><code>docker-compose.yml</code>内容如下：<div class="highlight highlight-source-yaml"><pre><span class="pl-ent">version</span>: <span class="pl-s"><span class="pl-pds">"</span>3<span class="pl-pds">"</span></span>
<span class="pl-ent">services</span>:
  <span class="pl-ent">nginx</span>:
    <span class="pl-ent">image</span>: <span class="pl-s">nginx</span>
    <span class="pl-ent">container_name</span>: <span class="pl-s">nginx</span>
    <span class="pl-ent">restart</span>: <span class="pl-s">always</span>
    <span class="pl-ent">volumes</span>:
      - <span class="pl-s">./nginx/config/nginx.conf:/etc/nginx/nginx.conf</span>
      - <span class="pl-s">./nginx/config/conf.d:/etc/nginx/conf.d</span>
      - <span class="pl-s">./nginx/logs:/var/log/nginx</span>
    <span class="pl-ent">ports</span>:
      - <span class="pl-s"><span class="pl-pds">"</span>80:80<span class="pl-pds">"</span></span>
    <span class="pl-ent">environment</span>:
      - <span class="pl-s">NGINX_PORT=80</span>
    <span class="pl-ent">links</span>:
      - <span class="pl-s">frp</span>
  
  <span class="pl-ent">frp</span>:
    <span class="pl-ent">image</span>: <span class="pl-s">snowdreamtech/frps</span>
    <span class="pl-ent">container_name</span>: <span class="pl-s">frp</span>
    <span class="pl-ent">restart</span>: <span class="pl-s">always</span>
    <span class="pl-ent">ports</span>:
      - <span class="pl-s"><span class="pl-pds">"</span>7000:7000<span class="pl-pds">"</span></span> <span class="pl-c"><span class="pl-c">#</span> 里的端口与 frps.ini 中 bind_port 保持一致</span>
    <span class="pl-ent">volumes</span>:
      - <span class="pl-s">./frp/config/frps.ini:/etc/frp/frps.ini</span></pre></div><p>nginx 的<code>default.conf</code>配置文件（可以先 run 一个 nginx 容器然后 通过<code>docker cp</code>得到默认配置）:<pre lang="conf"><code>server {
    listen       80;
    server_name  *.domain.com;

    location / {
        proxy_pass http://frp:8888; # 这里的端口与 frps.ini 中 vhost_http_port 保持一致
        proxy_set_header    Host $host;
        proxy_set_header    X-Real-IP $remote_addr;
        proxy_set_header    X-Forwarded-Proto https;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
</code></pre><p><code>frps.ini</code>配置文件：<div class="highlight highlight-source-ini"><pre><span class="pl-en">[common]</span>
<span class="pl-k">bind_port</span> = 7000
<span class="pl-k">vhost_http_port</span> = 8888</pre></div><p><code>frpc.ini</code>配置文件（这里是 frp 客户端配置，仅做参考）:<div class="highlight highlight-source-ini"><pre><span class="pl-en">[common]</span>
<span class="pl-k">server_addr</span> = x.x.x.x
<span class="pl-k">server_port</span> = 7000

<span class="pl-en">[xx sercer]</span>
<span class="pl-k">type</span> = http
<span class="pl-k">local_port</span> = xxx
<span class="pl-k">custom_domains</span> = sub.domain.com</pre></div><p>完成所有配置之后在<code>docker-compose.yml</code>所在的目录执行<code>docker-compose up</code>完成验证即可。<h2><a href="#%E9%AA%8C%E8%AF%81"class="anchor"aria-hidden="true"id="user-content-验证"><span class="octicon octicon-link"aria-hidden="true"></span></a>验证</h2><p>按照上述配置之后，原来通过<code>sub.domain.com:8888</code>才能访问的内网 web 服务现在只需要通过<code>sub.domain.com</code>访问即可。</section></article><footer class="footer-container"><section>Copyright &copy; 2020&nbsp;<a href="mailto:zowiegong@gmail.com">zowiegong</a>&nbsp;Powered by&nbsp;<a href="https://github.com/hexojs/hexo"target="_blank"rel="noopener noreferrer">Hexo</a>&nbsp;Theme by&nbsp;<a href="https://github.com/zowiegong/hexo-theme-os"target="_blank"rel="noopener noreferrer">OS.</a><br><a href="https://github.com/zowiegong/hexo-blog/edit/master/source/_posts/docker部署nginx-frp内网穿透.md"target="_blank">Edit source file</a></section></footer><div class="hover-pointer"id="scroll-to-top-container"><svg class="hover-fill"height="3rem "id="scroll-to-top-btn"version="1.1"viewBox="0 0 1024 1024"width="3rem"><path d="M825.568 555.328l-287.392-289.28C531.808 259.648 523.488 256.576 515.2 256.64 514.08 256.544 513.12 256 512 256c-4.672 0-9.024 1.088-13.024 2.88-4.032 1.536-7.872 3.872-11.136 7.136l-259.328 258.88c-12.512 12.48-12.544 32.736-0.032 45.248 6.24 6.272 14.432 9.408 22.656 9.408 8.192 0 16.352-3.136 22.624-9.344L480 364.288 480 928c0 17.696 14.336 32 32 32s32-14.304 32-32L544 362.72l236.192 237.728c6.24 6.272 14.496 9.44 22.688 9.44s16.32-3.104 22.56-9.312C838.016 588.128 838.048 567.84 825.568 555.328z"p-id="1100"></path><path d="M864 192 160 192C142.336 192 128 177.664 128 160s14.336-32 32-32l704 0c17.696 0 32 14.336 32 32S881.696 192 864 192z"p-id="1101"></path></svg></div><script>let pluginsConfig = JSON.parse('{"googleAnalytics":"UA-121105508-1","scrollToTop":true,"scrollSmooth":false,"comments":{"enable":true,"repo":"zowiegong/hexo-blog"}}')</script><script>pluginsConfig.comments.enable = true</script><script src="/js/script.js"></script>